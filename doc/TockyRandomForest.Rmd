---
title: "Introduction to TockyRandomForest Analysis"  
author: "Dr. Masahiro Ono"  
date: "`r Sys.Date()`"  
output: rmarkdown::html_vignette  
bibliography: TockyRandomForest.bib  
csl: apa.csl  
link-citations: TRUE  
vignette: >  
  %\VignetteIndexEntry{Introduction to TockyRandomForest Analysis}  
  %\VignetteEngine{knitr::rmarkdown}  
  %\VignetteEncoding{UTF-8}  
---

![](assets/TockyRandomForest.png){width=80% align="center"}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

Fluorescent Timer proteins uniquely change their emission spectra over time, serving as powerful tools for monitoring dynamic processes within cells. Our recent efforts have successfully implemented data preprocessing methods in the **TockyPrep** package (@TockyPrep2024). Additionally, to analyze Timer fluorescence dynamics and apply quantitative and statistical analysis methods, we have developed the **TockyLocus** package (@TockyLocus2024). However, analyzing complex Timer profiles, as typically seen in flow cytometric data from Foxp3-Tocky mice, remains challenging.

**Aim**

To overcome these challenges, applying machine learning methods is an attractive approach. The current package family, **TockyMachineLearning**, provides comprehensive methods for identifying feature cells that represent group-specific features in Timer profiles. Specifically, the **TockyRandomForest** package offers Random Forest methods developed for analyzing flow cytometric Fluorescent Timer data.

## Relationship to the Packages TockyPrep and TockyLocus

The **TockyPrep** package is designed to facilitate data preprocessing for flow cytometric Fluorescent Timer data. Subsequently, the **TockyLocus** package leverages this preprocessed data to apply data categorization methods, enabling quantitative analysis of Timer Angle data (@Bending2018a). However, this approach is applicable to one-dimensional data only.

The **TockyRandomForest** package utilizes the special object class provided by the **TockyPrep** package to perform advanced analyses on multi-dimensional data.

## Getting Started with **TockyRandomForest**

To begin using **TockyRandomForest**, you need to install both the TockyRandomForest and TockyPrep packages from GitHub:

```R
# Install TockyPrep and TockyRandomForest from GitHub
devtools::install_github("MonoTockyLab/TockyPrep")
devtools::install_github("MonoTockyLab/TockyRandomForest")
```

## Sample Workflow

This section guides you through a typical analysis workflow using **TockyRandomForest** to process flow cytometric data of cells expressing Fluorescent Timer proteins. To facilitate the analysis, preprocessed data are provided, and the **TockyPrep** package offers methods to analyze data using its S4 object class `TockyPrepData`.

First, load the necessary packages.

```{r library, include=TRUE}
library(TockyPrep)
library(TockyRandomForest)
```

Load example data included in the **TockyRandomForest** package as follows:

```{r files, include=TRUE}
# Example data load
# Define the base path
file_path <- system.file("extdata", package = "TockyRandomForest")
filenames <- list.files(path = file_path, pattern = 'rda')
files <- file.path(file_path, filenames)
for(i in files){load(i)}
```

The dataset was generated by analyzing T-cells from Foxp3-Tocky mice (WT) and CRISPR-mediated Foxp3-Tocky mutants, specifically CNS2KO Foxp3-Tocky mice (KO).

## TockyKmeansRF Analysis

Use the `TockyKmeansRF` function to apply TockyKmeansRF to your data:

```{r TockyKmeansRF, include=TRUE}
out <- TockyKmeansRF(trainData, testData)
```

A single analysis using `TockyKmeansRF` may not yield highly efficient results for the test dataset.

## TockyKmeansRF Cluster Optimization

You can optimize the number of clusters to use by employing the `TockyRFClusterOptimization` function:

```{r TockyRFClusterOptimization, fig.width=8, fig.height=8, include=TRUE}
roc_results <- TockyRFClusterOptimization(trainData, testData, num_cluster_vec = c(6, 12, 15, 20, 25, 30), k = 50, ctrl_group = 'KO', expr_group = 'WT')

library(gridExtra)
grid.arrange(grobs = roc_results$roc_plots)
```

## TockyRandomForest Analysis for Feature Cell Identification

In the following sections, we will use the cluster number 15.

Use the `TockyRandomForestAnalysis` function to iteratively apply `TockyKmeansRF` to your data:

```{r TockyRandomForestAnalysis, fig.width=8, fig.height=4, include=TRUE}
result <- TockyRandomForestAnalysis(trainData, testData, percentile = 0.5, num_cluster = 15, k = 50, ROC = TRUE, verbose = FALSE, ctrl_group = 'KO', expr_group = 'WT')
```

Use the `plotTockyRandomForestAnalysis` function to plot the output.

Using the option `plot = 'Importance Score', raw_timer = TRUE`, feature cells can be visualized in Timer blue and red fluorescence data.

```{r plotTockyRandomForestAnalysis_timer, fig.width=8, fig.height=4, include=TRUE}
plotTockyRandomForestAnalysis(trainData, result, percentile = 0.5, select = FALSE, plot = 'Importance Score', raw_timer = TRUE) 
```

Using the option `plot = 'ROC'`, the ROC curve can be plotted.

```{r plotTockyRandomForestAnalysis, fig.width=4, fig.height=4, include=TRUE}
plotTockyRandomForestAnalysis(trainData, result, percentile = 0.5, select = FALSE, plot = 'ROC')
```

### Clustering Feature Cells

Next, use the output object `result` from `TockyRandomForestAnalysis` to cluster feature cells using DBScan clustering.

```{r clusteringFeatureCells, fig.width=8, fig.height=4, include=TRUE}
cluster_result <- clusteringFeatureCells(trainData, result, percentile = 0.5, eps_value = 2, minPts_value = 4)
```

## Convex Hull Gating for Feature Cells

To use a convex hull gating approach, obtain cluster IDs and importance scores from the analyses above.

```{r cluster, fig.width=5, fig.height=5, include=TRUE}
cluster_ids <- cluster_result$cluster
cluster_ids <- sub(pattern = 0, replacement = 2, cluster_ids)
importance_scores <- result$importance_score
```

Then use `plotHullsGating` to analyze the percentage of cells falling in each of the hull-gated feature cell clusters per sample.

```{r plotHullsGating, fig.width=5, fig.height=5, include=TRUE}
output <- plotHullsGating(trainData, importance_scores = importance_scores, cell_cluster_id = cluster_ids)
```

The output object from the `plotHullsGating` function includes violin plots that illustrate the group effects on the percentage of cells within each cluster. These plots are stored as a list object and can be organized into a grid layout using the `gridExtra` package. You can display them as follows:


```{r gridExtra, fig.width=8, fig.height=4, include=TRUE}
library(gridExtra)
grid.arrange(grobs = output$plot, ncol = 3)
```

The statistical output can be accessed as follows:

```{r show_stats, fig.width=5, fig.height=5, include=TRUE}
show(output$stats)
```

![](assets/MonoLab.jpg){width=40% align="center"}  
![](assets/tockymachinelearning.jpg){width=70% align="center"}

# References
