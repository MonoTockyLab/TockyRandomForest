---
title: "Getting Started with TockyRandomForest Analysis"  
author: "Dr Masahiro Ono"  
date: "`r Sys.Date()`"  
output: rmarkdown::html_vignette  
bibliography: TockyRandomForest.bib  
link-citations: TRUE
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Getting Started with TockyRandomForest Analysis}
  %\VignetteEngine{knitr::rmarkdown}
---

![](assets/LogoTockyRandomForest.jpg){width=30% align="center"}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction to Fluorescent Timer and the Tocky System 

Fluorescent Timer proteins change their emission spectra over time, serving as powerful tools for monitoring transcriptional dynamics in vivo. Our recent efforts have successfully implemented data preprocessing methods in the **TockyPrep** package (@TockyPrep2024, @TockyPrep2025). Additionally, to analyze Timer fluorescence dynamics and apply quantitative and statistical analysis methods, we have developed the **TockyLocus** package (@TockyLocus2024). However, analyzing complex Timer profiles, as typically seen in flow cytometric data from Foxp3-Tocky mice, remains challenging.

**Aim**

To overcome these challenges, applying machine learning methods is an attractive approach. The package suite, **TockyMachineLearning**, provides comprehensive methods for identifying feature cells that represent group-specific features in Timer profiles. 

Specifically, the current **TockyRandomForest** package offers Random Forest methods developed for analyzing flow cytometric Fluorescent Timer data.

## Relationship to the Packages TockyPrep and TockyLocus

The **TockyPrep** package is designed to facilitate data preprocessing for flow cytometric Fluorescent Timer data. Subsequently, the **TockyLocus** package leverages this preprocessed data to apply data categorization methods, enabling quantitative analysis of Timer Angle data (@Bending2018a). However, this approach is applicable to one-dimensional data only.

The **TockyRandomForest** package utilizes the special object class `TockyPrepData` provided by the **TockyPrep** package to perform machine learning analysis

## Install **TockyRandomForest**

To begin using **TockyRandomForest**, you need to install both the TockyRandomForest and TockyPrep packages from GitHub:

```R
# Install TockyPrep and TockyRandomForest from GitHub
devtools::install_github("MonoTockyLab/TockyPrep")
devtools::install_github("MonoTockyLab/TockyRandomForest")
```

# Sample Workflow

## Identifying CNS2-dependent Foxp3 transcriptional dynamics

This section guides you through a typical analysis workflow using **TockyRandomForest** to process flow cytometric data of cells expressing Fluorescent Timer proteins. To facilitate the analysis, preprocessed data are provided, and the **TockyPrep** package offers methods to analyze data using its S4 object class `TockyPrepData`.

First, load the necessary packages.

```{r library, include=TRUE}
library(TockyPrep)
library(TockyRandomForest)
library(gridExtra)
```

Load example `TockyPrepData` objects included in the **TockyRandomForest** package as follows:

```{r files, include=TRUE}
# Example data load
# Define the base path
file_path <- system.file("extdata", package = "TockyRandomForest")
filenames <- list.files(path = file_path, pattern = 'CNS2.rda')
files <- file.path(file_path, filenames)
for(i in files){load(i)}
```

The dataset was generated by analyzing T-cells from Foxp3-Tocky mice (WT) and CRISPR-mediated Foxp3-Tocky mutants, specifically CNS2KO Foxp3-Tocky mice (KO). Here we aim to identify CNS2-dependent Foxp3 transcription dynamics in the Timer space in a data-oriented manner.


## TockyKmeansRF Analysis for Feature Cell Identification

We will use the `TockyKmeansRF` function to perform TockyRandomForest learning on `train_x` and testing on `test_y`. Note that these two datasets are independent of each other.

```{r train_x, fig.width=8, fig.height=4, include=TRUE}
show(train_x)
show(test_y)
```

The `TockyKmeansRF` function performs both a model training using a training dataset and a model testing using an independent test dataset.

```{r TockyKmeansRF, fig.width=8, fig.height=4, include=TRUE}
result_rf <- TockyKmeansRF(train_x, test_y, num_cluster = 18)
```


### Clustering Feature Cells

```{r plotImportanceScores, fig.width=7, fig.height=3, include=TRUE}
plotImportanceScores(result_rf, percentile = 0.6)
```

Next, use the output object `result` from `TockyRandomForestAnalysis` to cluster feature cells.

```{r ClusteringFeatureCells, fig.width=4, fig.height=4, include=TRUE}
result_rf = ClusteringFeatureCells(result_rf, percentile = 0.6, eps = 2, minPts = 3)
```

The function `ClusteringFeatureCells` utilises the DBScan algorithm. The parameters `eps` and `minPts` may need to be adjusted to optimise the clustering results.

Use `violinPlotFeatureCells` to analyse group-specific effects as captured by the TockyKmeansRF model.

```{r violinPlotFeatureCells, fig.width=8, fig.height=6, include=TRUE}
p = violinPlotFeatureCells(result_rf, ncol = 2)

plot(p)
```


## Marker Expression Analysis
Lestly, analyse the marker expression of identified clusters.


```{r plotMFIcluster, fig.width=7, fig.height=4,include=TRUE}
p2 <- plotClusterMFI(test_y, result_rf, min_cells = 10, group = 'WT')

```

## Final Notes

TockyRandomForest is a component of the comprehensive TockyMachineLearning package suite, designed to support advanced machine learning analyses in Tocky studies. Explore the other packages within the suite to fully leverage the potential of your datasets!

![](assets/TockyRandomForest.png){width=80% align="center"}


![](assets/MonoLab.jpg){width=40% align="center"}  

# References